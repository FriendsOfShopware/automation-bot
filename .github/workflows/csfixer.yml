name: PHPCSFixer
on:
  workflow_dispatch:
    inputs:
      id:
        description: "Execution ID"
        required: true

permissions:
  id-token: write

jobs:
  fix_codestyle:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch scoped token
        id: fetch-token
        uses: FriendsOfShopware/automation-bot/actions/fetch-token@main
        with:
          id: "${{ inputs.id }}"

      - name: Parse args
        id: parse-args
        run: |
          ARGS='${{ steps.fetch-token.outputs.args }}'
          PHP_VERSION=$(echo "$ARGS" | jq -r '.[0] // "8.2"')
          RULES=$(echo "$ARGS" | jq -r '.[1] // "@PER-CS2.0,no_unused_imports"')
          echo "php-version=$PHP_VERSION" >> $GITHUB_OUTPUT
          echo "rules=$RULES" >> $GITHUB_OUTPUT

      - uses: actions/checkout@v4
        with:
          repository: "${{ steps.fetch-token.outputs.head-owner }}/${{ steps.fetch-token.outputs.head-repo }}"
          ref: "${{ steps.fetch-token.outputs.head-branch }}"
          token: ${{ steps.fetch-token.outputs.token }}

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "${{ steps.parse-args.outputs.php-version }}"
          tools: php-cs-fixer

      - name: Run CSFixer
        id: csfixer
        run: |
          php-cs-fixer fix . --rules="${{ steps.parse-args.outputs.rules }}"
          if ! git diff HEAD --quiet; then
            githubUsername="frosh-automation"
            githubId="188718289"
            githubEmail="${githubId}+${githubUsername}[bot]@users.noreply.github.com"
            git config --global user.name "${githubUsername}"
            git config --global user.email "${githubEmail}"
            git add .
            git commit -m "fix: code-style"
            git push origin "HEAD:${{ steps.fetch-token.outputs.head-branch }}"
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Report result
        uses: FriendsOfShopware/automation-bot/actions/report-data@main
        with:
          id: "${{ inputs.id }}"
          data: '{"changes": ${{ steps.csfixer.outputs.changes }}}'
